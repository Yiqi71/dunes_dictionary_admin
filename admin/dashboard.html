
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>沙丘词典中台 Dunes Dictionary Dashboard</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background-color: #fdfcf8;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #d6d3d1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a8a29e;
    }
  </style>
</head>

<body class="text-stone-900 min-h-screen p-6 md:p-10">
  <!-- Navbar / Top Bar -->
  <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-8 pb-6 border-b border-stone-200 gap-4">
    <div>
      <h1 class="text-3xl font-bold tracking-tight text-stone-900">
        沙丘词典中台 <span class="text-stone-400 font-light mx-2">|</span> Dunes Dictionary Dashboard
      </h1>
      <p class="text-stone-500 text-sm mt-1 tracking-wide uppercase">数据看板 & 运营中心 Analytics & Operations</p>
    </div>

    <div class="flex flex-wrap items-center gap-3">
      <div class="flex items-center gap-2 text-sm text-stone-500">
        <span id="statusDot" class="inline-block w-2.5 h-2.5 rounded-full bg-stone-300"></span>
        <span id="statusText">未连接</span>
      </div>

      <button id="refreshBtn" class="px-3 py-2 rounded-md bg-white border border-stone-200 text-stone-700 text-sm hover:bg-stone-50">
        刷新 Refresh
      </button>

      <div class="relative">
        <button id="exportBtn" class="flex items-center gap-2 bg-stone-900 text-white px-4 py-2 rounded-md hover:bg-stone-800 transition-colors shadow-sm text-sm">
          <i data-lucide="download" class="w-4 h-4"></i>
          导出数据 Export Data
          <span class="text-[10px] bg-stone-700/80 px-1.5 py-0.5 rounded">未实现</span>
          <i data-lucide="chevron-down" class="w-3 h-3"></i>
        </button>

        <div id="exportMenu" class="hidden absolute right-0 mt-2 w-52 bg-white border border-stone-200 rounded-md shadow-lg z-20 py-1">
          <button class="w-full text-left px-4 py-2 text-sm text-stone-700 hover:bg-stone-50">
            上周数据 (.xlsx)
          </button>
          <button class="w-full text-left px-4 py-2 text-sm text-stone-700 hover:bg-stone-50">
            所有数据 (.xlsx)
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto space-y-8">
    <!-- Row 1: Overview -->
    <div class="flex items-center gap-2 mb-3 mt-6">
      <div class="w-1 h-4 bg-amber-600 rounded-full"></div>
      <h2 class="text-lg font-bold text-stone-800">总览 Overview</h2>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="bg-white border border-stone-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow duration-300">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">访问用户 Total UV (24h)</h3>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border bg-green-100 text-green-800 border-green-200">
            <i data-lucide="activity" class="w-2.5 h-2.5 mr-1 animate-pulse"></i> 实时
          </span>
        </div>
        <div class="flex items-baseline gap-2">
          <span id="statVisits" class="text-4xl font-bold text-stone-900">-</span>
        </div>
        <p class="text-stone-400 text-xs mt-2">基于 word_view_start</p>
      </div>

      <div class="bg-white border border-stone-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow duration-300">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">平均停留 Avg Stay (24h)</h3>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border bg-green-100 text-green-800 border-green-200">
            <i data-lucide="activity" class="w-2.5 h-2.5 mr-1 animate-pulse"></i> 实时
          </span>
        </div>
        <div class="flex items-baseline gap-2">
          <span id="statAvgStay" class="text-4xl font-bold text-stone-900">-</span>
        </div>
        <p class="text-stone-400 text-xs mt-2">基于 word_view_end.durationMs</p>
      </div>

      <div class="bg-white border border-stone-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow duration-300">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">活跃词条 Active Terms (24h)</h3>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border bg-green-100 text-green-800 border-green-200">
            <i data-lucide="activity" class="w-2.5 h-2.5 mr-1 animate-pulse"></i> 实时
          </span>
        </div>
        <div class="flex items-baseline gap-2">
          <span id="statActiveTerms" class="text-4xl font-bold text-stone-900">-</span>
        </div>
        <p class="text-stone-400 text-xs mt-2">wordId 去重</p>
      </div>

      <div class="bg-white border border-stone-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow duration-300">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">会话数 Sessions (24h)</h3>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border bg-green-100 text-green-800 border-green-200">
            <i data-lucide="activity" class="w-2.5 h-2.5 mr-1 animate-pulse"></i> 实时
          </span>
        </div>
        <div class="flex items-baseline gap-2">
          <span id="statSessions" class="text-4xl font-bold text-stone-900">-</span>
        </div>
        <p class="text-stone-400 text-xs mt-2">sessionId 去重</p>
      </div>
    </div>
    <!-- Row 2: Language Stats -->
    <div class="flex items-center gap-2 mb-3 mt-6">
      <div class="w-1 h-4 bg-amber-600 rounded-full"></div>
      <h2 class="text-lg font-bold text-stone-800">语言分布 Language <span class="text-xs text-stone-400">（未实现）</span></h2>
    </div>

    <div class="grid grid-cols-1 gap-6">
      <div class="bg-white border border-stone-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow duration-300">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">中英文切换 EN/CN Switch</h3>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border bg-stone-100 text-stone-600 border-stone-200">
            <i data-lucide="clock" class="w-2.5 h-2.5 mr-1"></i> 昨日 Yesterday
          </span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 divide-y md:divide-y-0 md:divide-x divide-stone-100">
          <div class="flex flex-col justify-center px-4">
            <div class="text-stone-500 text-xs uppercase mb-1">英文切换点击 EN Switch Clicks</div>
            <div id="langEnClicks" class="text-3xl font-bold text-stone-900">-</div>
            <div class="text-xs text-stone-400 mt-1">按钮交互总量 Total interactions</div>
          </div>
          <div class="flex flex-col justify-center px-4">
            <div class="text-stone-500 text-xs uppercase mb-1">渗透率 Penetration Rate</div>
            <div id="langPenetration" class="text-3xl font-bold text-amber-600">-</div>
            <div class="text-xs text-stone-400 mt-1">点击占比 Clicks / Total</div>
          </div>
          <div class="flex flex-col justify-center px-4">
            <div class="text-stone-500 text-xs uppercase mb-1">有效时长比 (英 vs 中)</div>
            <div class="text-3xl font-bold text-stone-900">-</div>
            <div class="w-full h-1.5 bg-stone-100 rounded-full mt-3 overflow-hidden flex">
              <div id="langBarEn" class="bg-stone-300 h-full w-[50%]"></div>
              <div id="langBarZh" class="bg-stone-200 h-full w-[50%]"></div>
            </div>
            <div class="flex justify-between text-[10px] text-stone-400 mt-1">
              <span>英文 EN</span>
              <span>中文 CN</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 3: Trend Chart -->
    <div class="flex items-center gap-2 mb-3 mt-6">
      <div class="w-1 h-4 bg-amber-600 rounded-full"></div>
      <h2 class="text-lg font-bold text-stone-800">流量趋势 Trends</h2>
    </div>

    <div class="bg-white border border-stone-200 rounded-lg p-6 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
        <div class="flex items-center gap-2">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">访问量 Visits</h3>
          <span id="trendRangeText" class="text-xs text-stone-400">7d</span>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex bg-stone-100 p-1 rounded-md">
            <button id="tab7d" class="px-3 py-1 text-xs font-medium rounded bg-white shadow text-stone-900 transition-all">过去7天</button>
            <button id="tab30d" class="px-3 py-1 text-xs font-medium rounded text-stone-500 hover:text-stone-700 transition-all">过去30天</button>
          </div>
          <span id="trendNote" class="text-xs text-stone-400">黑色: 中文版本 / 橙色: 英文版本</span>
        </div>
      </div>

      <div class="h-[300px] w-full relative">
        <canvas id="trendChart"></canvas>
      </div>
    </div>

    <!-- Row 4: Content Table -->
    <div class="flex items-center gap-2 mb-3 mt-6">
      <div class="w-1 h-4 bg-amber-600 rounded-full"></div>
      <h2 class="text-lg font-bold text-stone-800">词条分析 Content Breakdown</h2>
    </div>

    <div class="bg-white border border-stone-200 rounded-lg shadow-sm overflow-hidden flex flex-col">
      <div class="p-4 border-b border-stone-200 flex flex-col md:flex-row md:items-center md:justify-between gap-3 bg-stone-50/50">
        <div class="flex flex-wrap gap-3 items-center">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">词条列表 Entries List</h3>
          <div class="flex bg-stone-200 p-0.5 rounded text-[10px] font-medium">
            <button class="px-2 py-0.5 rounded transition-all bg-white text-stone-900 shadow-sm">中文 CN</button>
            <button class="px-2 py-0.5 rounded transition-all text-stone-500 hover:text-stone-700">英文 EN</button>
          </div>
          <span class="bg-stone-200 text-stone-600 text-[10px] px-2 py-0.5 rounded-full">语言切换（未实现）</span>
        </div>
        <div class="flex flex-wrap gap-2 items-center">
          <div class="flex gap-2">
            <button id="range7d" class="px-3 py-1 rounded-md bg-stone-900 text-white text-xs">7d</button>
            <button id="range24h" class="px-3 py-1 rounded-md bg-white border border-stone-200 text-stone-700 text-xs">24h</button>
            <button id="range30d" class="px-3 py-1 rounded-md bg-white border border-stone-200 text-stone-700 text-xs">30d</button>
          </div>
          <div class="flex gap-2 text-stone-400 items-center">
            <i data-lucide="filter" class="w-4 h-4"></i>
            <span class="text-xs">过滤来源（未实现）</span>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead class="bg-white text-stone-500 font-medium border-b border-stone-100">
            <tr>
              <th class="px-6 py-4 font-normal">词条信息 Term Info</th>
              <th class="px-6 py-4 font-normal">上站天数 Days Active</th>
              <th class="px-6 py-4 font-normal">昨日访问 Visits (Yest.)</th>
              <th class="px-6 py-4 font-normal">总访问 Total Visits</th>
              <th class="px-6 py-4 font-normal">总时长 Total Duration</th>
            </tr>
          </thead>
          <tbody id="term-table-body" class="divide-y divide-stone-100">
            <!-- Rows generated by JS -->
          </tbody>
        </table>
      </div>
      <div id="term-pagination" class="p-4 border-t border-stone-100 bg-white flex justify-end items-center gap-2">
        <!-- Pagination generated by JS -->
      </div>
    </div>
    <!-- Row 5: Interaction Stats Grid -->
    <div class="flex items-center gap-2 mb-3 mt-6">
      <div class="w-1 h-4 bg-amber-600 rounded-full"></div>
      <h2 class="text-lg font-bold text-stone-800">交互行为 Interactions & UX</h2>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="bg-white border border-stone-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow duration-300 border-t-4 border-t-stone-700">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">搜索 Search</h3>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border bg-stone-100 text-stone-600 border-stone-200">
            <i data-lucide="clock" class="w-2.5 h-2.5 mr-1"></i> 24h
          </span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-stone-100">
          <span class="text-stone-500 text-sm">总使用次数 Total Usage</span>
          <div class="text-right">
            <div id="countSearch" class="text-stone-800 font-medium">-</div>
          </div>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-stone-100 last:border-0">
          <span class="text-stone-500 text-sm">使用率 Usage Rate</span>
          <div class="text-right">
            <div id="pctSearch" class="text-stone-800 font-medium">-</div>
            <div class="text-xs text-stone-400">% 总用户占比 % of UV</div>
          </div>
        </div>
        <div class="mt-3 h-1.5 bg-stone-100 rounded-full overflow-hidden">
          <div id="barSearch" class="bg-stone-700 h-full" style="width: 0%"></div>
        </div>
      </div>

      <div class="bg-white border border-stone-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow duration-300 border-t-4 border-t-stone-400">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">时间轴 Timeline</h3>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border bg-stone-100 text-stone-600 border-stone-200">
            <i data-lucide="clock" class="w-2.5 h-2.5 mr-1"></i> 24h
          </span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-stone-100">
          <span class="text-stone-500 text-sm">总使用次数 Total Usage</span>
          <div class="text-right">
            <div id="countTimeline" class="text-stone-800 font-medium">-</div>
          </div>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-stone-100 last:border-0">
          <span class="text-stone-500 text-sm">使用率 Usage Rate</span>
          <div class="text-right">
            <div id="pctTimeline" class="text-stone-800 font-medium">-</div>
            <div class="text-xs text-stone-400">% 总用户占比 % of UV</div>
          </div>
        </div>
        <div class="mt-3 h-1.5 bg-stone-100 rounded-full overflow-hidden">
          <div id="barTimeline" class="bg-stone-400 h-full" style="width: 0%"></div>
        </div>
      </div>

      <div class="bg-white border border-stone-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow duration-300 border-t-4 border-t-amber-600">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">点击连线 Link Click</h3>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border bg-stone-100 text-stone-600 border-stone-200">
            <i data-lucide="clock" class="w-2.5 h-2.5 mr-1"></i> 24h
          </span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-stone-100">
          <span class="text-stone-500 text-sm">总使用次数 Total Usage</span>
          <div class="text-right">
            <div id="countLink" class="text-stone-800 font-medium">-</div>
          </div>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-stone-100 last:border-0">
          <span class="text-stone-500 text-sm">使用率 Usage Rate</span>
          <div class="text-right">
            <div id="pctLink" class="text-stone-800 font-medium">-</div>
            <div class="text-xs text-stone-400">% 总用户占比 % of UV</div>
          </div>
        </div>
        <div class="mt-3 h-1.5 bg-stone-100 rounded-full overflow-hidden">
          <div id="barLink" class="bg-amber-600 h-full" style="width: 0%"></div>
        </div>
      </div>

      <div class="bg-white border border-stone-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow duration-300 border-t-4 border-t-stone-600">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">地图点击 Map Click</h3>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border bg-stone-100 text-stone-600 border-stone-200">
            <i data-lucide="clock" class="w-2.5 h-2.5 mr-1"></i> 24h
          </span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-stone-100">
          <span class="text-stone-500 text-sm">总使用次数 Total Usage</span>
          <div class="text-right">
            <div id="countMap" class="text-stone-800 font-medium">-</div>
          </div>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-stone-100 last:border-0">
          <span class="text-stone-500 text-sm">使用率 Usage Rate</span>
          <div class="text-right">
            <div id="pctMap" class="text-stone-800 font-medium">-</div>
            <div class="text-xs text-stone-400">% 总用户占比 % of UV</div>
          </div>
        </div>
        <div class="mt-3 h-1.5 bg-stone-100 rounded-full overflow-hidden">
          <div id="barMap" class="bg-stone-600 h-full" style="width: 0%"></div>
        </div>
      </div>

      <div class="bg-white border border-stone-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow duration-300 border-t-4 border-t-stone-800">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">随机 Shuffle</h3>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border bg-stone-100 text-stone-600 border-stone-200">
            <i data-lucide="clock" class="w-2.5 h-2.5 mr-1"></i> 24h
          </span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-stone-100">
          <span class="text-stone-500 text-sm">总使用次数 Total Usage</span>
          <div class="text-right">
            <div id="countShuffle" class="text-stone-800 font-medium">-</div>
          </div>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-stone-100 last:border-0">
          <span class="text-stone-500 text-sm">使用率 Usage Rate</span>
          <div class="text-right">
            <div id="pctShuffle" class="text-stone-800 font-medium">-</div>
            <div class="text-xs text-stone-400">% 总用户占比 % of UV</div>
          </div>
        </div>
        <div class="mt-3 h-1.5 bg-stone-100 rounded-full overflow-hidden">
          <div id="barShuffle" class="bg-stone-800 h-full" style="width: 0%"></div>
        </div>
      </div>

      <div class="bg-white border border-stone-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow duration-300 border-t-4 border-t-stone-200">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-stone-500 text-sm font-bold uppercase tracking-wider">关于 点击 About</h3>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border bg-stone-100 text-stone-600 border-stone-200">
            <i data-lucide="clock" class="w-2.5 h-2.5 mr-1"></i> 24h
          </span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-stone-100">
          <span class="text-stone-500 text-sm">总使用次数 Total Usage</span>
          <div class="text-right">
            <div id="countAbout" class="text-stone-800 font-medium">-</div>
          </div>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-stone-100 last:border-0">
          <span class="text-stone-500 text-sm">使用率 Usage Rate</span>
          <div class="text-right">
            <div id="pctAbout" class="text-stone-800 font-medium">-</div>
            <div class="text-xs text-stone-400">% 总用户占比 % of UV</div>
          </div>
        </div>
        <div class="mt-3 h-1.5 bg-stone-100 rounded-full overflow-hidden">
          <div id="barAbout" class="bg-stone-300 h-full" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <div class="h-10"></div>
  </div>

  <!-- Term Modal -->
  <div id="termModal" class="hidden fixed inset-0 bg-stone-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-opacity duration-200">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden">
      <div class="p-6 border-b border-stone-200 flex justify-between items-center bg-stone-50">
        <h2 id="modalTitle" class="text-xl font-bold text-stone-900">词条详情</h2>
        <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-white border border-transparent hover:border-stone-200 text-stone-500 hover:text-stone-900">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="p-6 space-y-5">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <p class="text-stone-400 text-xs mb-1 uppercase tracking-wider font-semibold">访问次数</p>
            <p id="modalVisits" class="text-2xl font-bold text-stone-800">-</p>
          </div>
          <div>
            <p class="text-stone-400 text-xs mb-1 uppercase tracking-wider font-semibold">阅读时长 (Sum)</p>
            <p id="modalDuration" class="text-2xl font-bold text-stone-800">-</p>
          </div>
          <div>
            <p class="text-stone-400 text-xs mb-1 uppercase tracking-wider font-semibold">活跃天数</p>
            <p id="modalActiveDays" class="text-2xl font-bold text-stone-800">-</p>
          </div>
        </div>

        <div class="h-64 w-full">
          <canvas id="detailChart"></canvas>
        </div>

        <p class="text-center text-stone-400 text-sm mt-2 italic font-light">近5日活跃趋势（按天聚合 word_view_start）</p>
      </div>
    </div>
  </div>

  <script>
    if (window.lucide && typeof window.lucide.createIcons === "function") {
      lucide.createIcons();
    }

    const POLL_MS = 10000;
    const EVENTS_LIMIT = 5000;
    const TERMS_PER_PAGE = 5;

    let trendChart = null;
    let detailChart = null;
    let currentRange = "7d";
    let currentTrendRange = "7d";
    let currentTermPage = 1;
    let lastEventsCache = [];

    const $ = (id) => document.getElementById(id);

    function setStatus(ok, msg) {
      $("statusDot").className = "inline-block w-2.5 h-2.5 rounded-full " + (ok ? "bg-emerald-500" : "bg-rose-500");
      $("statusText").innerText = msg;
    }

    function fmtMs(ms) {
      if (!ms || ms < 0) return "0s";
      const s = Math.round(ms / 1000);
      const m = Math.floor(s / 60);
      const r = s % 60;
      return m > 0 ? `${m}m ${r}s` : `${r}s`;
    }

    function startOfDay(ts) {
      const d = new Date(ts);
      d.setHours(0, 0, 0, 0);
      return d.getTime();
    }

    function inLast(ts, ms) {
      return (Date.now() - ts) <= ms;
    }

    function rangeToMs(range) {
      if (range === "24h") return 24 * 3600_000;
      if (range === "30d") return 30 * 24 * 3600_000;
      return 7 * 24 * 3600_000;
    }

    function buildTermAgg(events) {
      const m = new Map();
      for (const e of events) {
        const d = e && e.data ? e.data : {};
        if (e.name === "word_view_start" && d.wordId !== undefined) {
          const id = Number(d.wordId);
          if (!Number.isFinite(id)) continue;
          if (!m.has(id)) m.set(id, { wordId: id, visits: 0, durationMs: 0, days: new Set() });
          const t = m.get(id);
          t.visits += 1;
          t.days.add(startOfDay(e.ts));
        }
        if (e.name === "word_view_end" && d.wordId !== undefined) {
          const id = Number(d.wordId);
          if (!Number.isFinite(id)) continue;
          if (!m.has(id)) m.set(id, { wordId: id, visits: 0, durationMs: 0, days: new Set() });
          const t = m.get(id);
          if (typeof d.durationMs === "number") t.durationMs += d.durationMs;
          t.days.add(startOfDay(e.ts));
        }
      }

      return Array.from(m.values()).map(t => ({
        id: t.wordId,
        term: `词条 #${t.wordId}`,
        category: "Unknown",
        visits: t.visits,
        durationMs: t.durationMs,
        durationText: fmtMs(t.durationMs),
        activeDays: t.days.size
      })).sort((a, b) => b.visits - a.visits);
    }

    function buildLangMetrics(events) {
      if (!Array.isArray(events) || !events.length) return null;
      const recent24h = events.filter(e => inLast(e.ts, rangeToMs("24h")));
      const langEvents = recent24h.filter(e => e.name === "lang_toggle");
      const enEvents = langEvents.filter(e => (e.data?.to || "").startsWith("en"));
      const zhEvents = langEvents.filter(e => (e.data?.to || "").startsWith("zh"));
      const totalUsers = new Set(recent24h.map(e => e.sessionId).filter(Boolean)).size;
      const enUsers = new Set(enEvents.map(e => e.sessionId).filter(Boolean)).size;

      let enDurationMs = 0;
      let zhDurationMs = 0;
      const viewEnds = recent24h.filter(e => e.name === "word_view_end" && e.data && typeof e.data.durationMs === "number");
      viewEnds.forEach(e => {
        const lang = getEventLangKey(e);
        if (lang === "en") {
          enDurationMs += e.data.durationMs;
        } else {
          zhDurationMs += e.data.durationMs;
        }
      });

      return {
        enClicks: enEvents.length,
        zhClicks: zhEvents.length,
        enUsers,
        totalUsers,
        enDurationMs,
        zhDurationMs
      };
    }

    function renderLang(metrics) {
      if (!metrics) {
        $("langEnClicks").innerText = "-";
        $("langPenetration").innerText = "-";
        $("langBarEn").style.width = "50%";
        $("langBarZh").style.width = "50%";
        return;
      }
      const enClicks = metrics.enClicks ?? 0;
      const zhClicks = metrics.zhClicks ?? 0;
      const totalUsers = metrics.totalUsers ?? 0;
      const enUsers = metrics.enUsers ?? 0;
      const penetration = totalUsers ? Math.round((enUsers / totalUsers) * 100) : 0;
      const totalDuration = (metrics.enDurationMs ?? 0) + (metrics.zhDurationMs ?? 0);
      const enPct = totalDuration ? Math.round((metrics.enDurationMs / totalDuration) * 100) : 50;
      const zhPct = 100 - enPct;

      $("langEnClicks").innerText = enClicks.toLocaleString();
      $("langPenetration").innerText = `${penetration}%`;
      $("langBarEn").style.width = `${enPct}%`;
      $("langBarZh").style.width = `${zhPct}%`;
    }

    function getEventLangKey(e) {
      const d = e?.data || {};
      const raw = String(d.lang || d.language || d.locale || d.uiLang || d.to || "").toLowerCase();
      if (raw.startsWith("en")) return "en";
      if (raw.startsWith("zh") || raw.includes("cn")) return "cn";
      return null;
    }

    function buildTrendNd(events, daysCount) {
      const now = Date.now();
      const days = [];
      for (let i = daysCount - 1; i >= 0; i--) {
        const d = new Date(now - i * 24 * 3600_000);
        d.setHours(0, 0, 0, 0);
        days.push(d.getTime());
      }
      const counts = new Map(days.map(d => [d, 0]));
      for (const e of events) {
        if (e.name !== "word_view_start") continue;
        const d = startOfDay(e.ts);
        if (counts.has(d)) counts.set(d, counts.get(d) + 1);
      }
      const labels = days.map(d => {
        const dt = new Date(d);
        return `${dt.getMonth() + 1}/${dt.getDate()}`;
      });
      const data = days.map(d => counts.get(d) || 0);
      return { labels, data };
    }

    function buildTrendNdByLang(events, daysCount) {
      const now = Date.now();
      const days = [];
      for (let i = daysCount - 1; i >= 0; i--) {
        const d = new Date(now - i * 24 * 3600_000);
        d.setHours(0, 0, 0, 0);
        days.push(d.getTime());
      }
      const cnCounts = new Map(days.map(d => [d, 0]));
      const enCounts = new Map(days.map(d => [d, 0]));
      let missingLang = 0;
      for (const e of events) {
        if (e.name !== "word_view_start") continue;
        const day = startOfDay(e.ts);
        if (!cnCounts.has(day)) continue;
        const lang = getEventLangKey(e);
        if (lang === "en") {
          enCounts.set(day, enCounts.get(day) + 1);
        } else if (lang === "cn") {
          cnCounts.set(day, cnCounts.get(day) + 1);
        } else {
          missingLang += 1;
          cnCounts.set(day, cnCounts.get(day) + 1);
        }
      }
      const labels = days.map(d => {
        const dt = new Date(d);
        return `${dt.getMonth() + 1}/${dt.getDate()}`;
      });
      const cn = days.map(d => cnCounts.get(d) || 0);
      const en = days.map(d => enCounts.get(d) || 0);
      return { labels, cn, en, missingLang };
    }

    function buildTermTrend5d(events, wordId) {
      return buildTermTrendNd(events, wordId, 5);
    }

    function buildTermTrendNd(events, wordId, daysCount) {
      const now = Date.now();
      const days = [];
      for (let i = daysCount - 1; i >= 0; i--) {
        const d = new Date(now - i * 24 * 3600_000);
        d.setHours(0, 0, 0, 0);
        days.push(d.getTime());
      }
      const counts = new Map(days.map(d => [d, 0]));
      for (const e of events) {
        if (e.name !== "word_view_start") continue;
        const d = e.data || {};
        if (d.wordId !== wordId) continue;
        const day = startOfDay(e.ts);
        if (counts.has(day)) counts.set(day, counts.get(day) + 1);
      }
      const labels = days.map(d => {
        const dt = new Date(d);
        return `${dt.getMonth() + 1}/${dt.getDate()}`;
      });
      const data = days.map(d => counts.get(d) || 0);
      return { labels, data };
    }

    function setUsage(idCount, idText, idBar, count, pct) {
      $(idCount).innerText = (count ?? 0).toLocaleString();
      $(idText).innerText = `${pct ?? 0}%`;
      $(idBar).style.width = `${pct ?? 0}%`;
    }

    function buildInteractionMetrics(events, totalUsers) {
      const defs = [
        { key: "search", names: ["search_click"] },
        { key: "timeline", names: ["year_filter_change", "timeline_click"] },
        { key: "link", names: ["link_click"] },
        { key: "map", names: ["word_node_click", "menu_home_click"] },
        { key: "shuffle", names: ["shuffle_click"] },
        { key: "about", names: ["about_click"] }
      ];
      const interactions = {};
      const denom = totalUsers || 0;
      defs.forEach(def => {
        const matched = events.filter(e => def.names.includes(e.name));
        const count = matched.length;
        const users = new Set(matched.map(e => e.sessionId).filter(Boolean)).size;
        const pct = denom ? Math.round((users / denom) * 100) : 0;
        interactions[def.key] = { count, users, pct };
      });
      return { totalUsers, interactions };
    }

    function buildYesterdayVisitsMap(events) {
      const map = new Map();
      if (!Array.isArray(events) || !events.length) return map;
      const todayStart = startOfDay(Date.now());
      const yestStart = todayStart - 24 * 3600_000;
      events.forEach(e => {
        if (e.name !== "word_view_start") return;
        if (e.ts < yestStart || e.ts >= todayStart) return;
        const d = e.data || {};
        const id = Number(d.wordId);
        if (!Number.isFinite(id)) return;
        map.set(id, (map.get(id) || 0) + 1);
      });
      return map;
    }

    function buildFeatureFromEvents(events) {
      if (!Array.isArray(events) || !events.length) return null;
      const recent24h = events.filter(e => inLast(e.ts, rangeToMs("24h")));
      const sessions = new Set(recent24h.map(e => e.sessionId).filter(Boolean)).size;
      return buildInteractionMetrics(recent24h, sessions);
    }

    async function tryFetchJson(url) {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`${url} ${r.status}`);
      return await r.json();
    }

    async function loadFromApi() {
      const dash = await tryFetchJson("/api/dashboard");
      const terms = await tryFetchJson(`/api/terms?range=${currentRange}`);
      return { mode: "api", dash, terms };
    }

    async function loadFromEventsFallback() {
      const payload = await tryFetchJson(`/events?limit=${EVENTS_LIMIT}`);
      const events = payload.events || [];
      lastEventsCache = events;

      const rangeMs = rangeToMs("24h");
      const recent24h = events.filter(e => inLast(e.ts, rangeMs));

      const visits24h = recent24h.filter(e => e.name === "word_view_start").length;
      const sessionsSet = new Set(recent24h.map(e => e.sessionId).filter(Boolean));
      const sessions = sessionsSet.size;

      const viewEnds = recent24h.filter(e => e.name === "word_view_end" && e.data && typeof e.data.durationMs === "number");
      const avgMs = viewEnds.length ? Math.round(viewEnds.reduce((s, e) => s + e.data.durationMs, 0) / viewEnds.length) : 0;

      const termAgg24h = buildTermAgg(recent24h);
      const activeTerms = termAgg24h.length;

      const trend7d = buildTrendNdByLang(events, 7);
      const trend30d = buildTrendNdByLang(events, 30);

      const feature = buildInteractionMetrics(recent24h, sessions);

      const dash = {
        ok: true,
        stats: {
          visits24h,
          avgStay: fmtMs(avgMs),
          activeTerms,
          sessions
        },
        trend7d: { labels: trend7d.labels, cn: trend7d.cn, en: trend7d.en, missingLang: trend7d.missingLang },
        trend30d: { labels: trend30d.labels, cn: trend30d.cn, en: trend30d.en, missingLang: trend30d.missingLang },
        feature
      };

      const rangeMsTerms = rangeToMs(currentRange);
      const recentRange = events.filter(e => inLast(e.ts, rangeMsTerms));
      const terms = { ok: true, terms: buildTermAgg(recentRange).slice(0, 50) };

      return { mode: "events", dash, terms, events };
    }
    function renderStats(dash) {
      $("statVisits").innerText = (dash.stats.visits24h ?? 0).toLocaleString();
      $("statAvgStay").innerText = dash.stats.avgStay ?? "-";
      $("statActiveTerms").innerText = (dash.stats.activeTerms ?? 0).toLocaleString();
      $("statSessions").innerText = (dash.stats.sessions ?? 0).toLocaleString();
    }

    function normalizeTrendData(dash, range) {
      const key = range === "30d" ? "trend30d" : "trend7d";
      const t = dash[key];
      if (t && Array.isArray(t.labels)) {
        if (Array.isArray(t.cn) && Array.isArray(t.en)) {
          const note = t.missingLang ? `部分事件缺少语言字段，已默认归为中文 (${t.missingLang})` : "";
          return { labels: t.labels, cn: t.cn, en: t.en, note };
        }
        if (Array.isArray(t.data)) {
          return { labels: t.labels, cn: t.data, en: t.data.map(() => 0), note: "语言维度未提供，英文线为 0" };
        }
      }
      if (lastEventsCache.length) {
        const trend = buildTrendNdByLang(lastEventsCache, range === "30d" ? 30 : 7);
        const note = trend.missingLang ? `部分事件缺少语言字段，已默认归为中文 (${trend.missingLang})` : "";
        return { labels: trend.labels, cn: trend.cn, en: trend.en, note };
      }
      return { labels: [], cn: [], en: [], note: "趋势数据未实现（缺少数据源）" };
    }

    function renderTrend(dash) {
      if (typeof Chart === "undefined") return;
      const ctx = $("trendChart").getContext("2d");
      if (trendChart) trendChart.destroy();

      const trend = normalizeTrendData(dash, currentTrendRange);
      $("trendRangeText").innerText = currentTrendRange;
      const baseNote = "黑色: 中文版本 / 橙色: 英文版本";
      $("trendNote").innerText = trend.note ? `${baseNote} · ${trend.note}` : baseNote;

      trendChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: trend.labels,
          datasets: [
            {
              label: "中文版本",
              data: trend.cn,
              borderColor: "#1c1917",
              backgroundColor: "#1c1917",
              borderWidth: 2,
              tension: 0.4,
              pointRadius: 3,
              pointHoverRadius: 6
            },
            {
              label: "英文版本",
              data: trend.en,
              borderColor: "#f97316",
              backgroundColor: "#f97316",
              borderWidth: 2,
              tension: 0.4,
              pointRadius: 3,
              pointHoverRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom", labels: { usePointStyle: true, boxWidth: 6 } }
          },
          scales: {
            x: { grid: { display: false }, border: { display: false } },
            y: { grid: { color: "#e5e7eb" }, border: { display: false } }
          },
          interaction: { mode: "index", intersect: false }
        }
      });
    }

    function normalizeFeature(feature) {
      if (feature && feature.interactions) return feature;

      return {
        totalUsers: feature?.totalUsers ?? 0,
        interactions: {
          search: { count: 0, pct: feature?.searchPct ?? 0 },
          timeline: { count: 0, pct: 0 },
          link: { count: 0, pct: feature?.wordClickPct ?? 0 },
          map: { count: 0, pct: 0 },
          shuffle: { count: 0, pct: feature?.shufflePct ?? 0 },
          about: { count: 0, pct: 0 }
        }
      };
    }

    function renderFeature(dash) {
      const f = normalizeFeature(dash.feature || {});
      setUsage("countSearch", "pctSearch", "barSearch", f.interactions.search?.count, f.interactions.search?.pct);
      setUsage("countTimeline", "pctTimeline", "barTimeline", f.interactions.timeline?.count, f.interactions.timeline?.pct);
      setUsage("countLink", "pctLink", "barLink", f.interactions.link?.count, f.interactions.link?.pct);
      setUsage("countMap", "pctMap", "barMap", f.interactions.map?.count, f.interactions.map?.pct);
      setUsage("countShuffle", "pctShuffle", "barShuffle", f.interactions.shuffle?.count, f.interactions.shuffle?.pct);
      setUsage("countAbout", "pctAbout", "barAbout", f.interactions.about?.count, f.interactions.about?.pct);
    }

    function renderPagination(totalItems) {
      const totalPages = Math.max(1, Math.ceil(totalItems / TERMS_PER_PAGE));
      const container = $("term-pagination");
      const curr = Math.min(currentTermPage, totalPages);
      currentTermPage = curr;

      const makeBtn = (label, page, disabled, active) => `
        <button ${disabled ? "disabled" : ""} data-page="${page}" class="px-2 py-1 text-xs rounded ${active ? "bg-stone-900 text-white" : "text-stone-500 hover:bg-stone-100"} disabled:opacity-30 disabled:hover:bg-white">
          ${label}
        </button>
      `;

      let html = "";
      html += makeBtn("‹", Math.max(1, curr - 1), curr === 1, false);

      const maxBtns = 5;
      let startPage = 1;
      if (totalPages > maxBtns && curr > 3) {
        startPage = curr - 2;
        if (startPage + maxBtns > totalPages) startPage = totalPages - maxBtns + 1;
      }
      const endPage = Math.min(totalPages, startPage + maxBtns - 1);

      for (let i = startPage; i <= endPage; i++) {
        html += makeBtn(i, i, false, i === curr);
      }

      html += makeBtn("›", Math.min(totalPages, curr + 1), curr === totalPages, false);
      container.innerHTML = html;

      container.querySelectorAll("button[data-page]").forEach(btn => {
        btn.addEventListener("click", () => {
          const page = Number(btn.dataset.page);
          if (!Number.isFinite(page)) return;
          currentTermPage = page;
          renderTable(termsPayload, window.__yesterdayMap);
        });
      });
    }

    function renderTable(termsPayload, yesterdayMap = new Map()) {
      const terms = termsPayload.terms || [];
      const tb = $("term-table-body");
      tb.innerHTML = "";

      const start = (currentTermPage - 1) * TERMS_PER_PAGE;
      const pageData = terms.slice(start, start + TERMS_PER_PAGE);
      const hasYesterday = yesterdayMap && yesterdayMap.size;

      pageData.forEach(item => {
        const yestVisits = hasYesterday ? (yesterdayMap.get(item.id) || 0) : "-";
        const row = document.createElement("tr");
        row.className = "hover:bg-amber-50/30 transition-colors group cursor-pointer";
        row.addEventListener("click", () => openModal(item.id));
        row.innerHTML = `
          <td class="px-6 py-4">
            <div class="font-bold text-stone-900">${item.term}</div>
            <div class="text-xs text-stone-500">分类: ${item.category || "Unknown"}</div>
            <div class="text-[10px] text-stone-300 mt-1 font-mono">ID: ${item.id}</div>
          </td>
          <td class="px-6 py-4 text-stone-600 font-medium">${(item.activeDays ?? 0).toLocaleString()}</td>
          <td class="px-6 py-4 text-stone-600 font-medium">${typeof yestVisits === "number" ? yestVisits.toLocaleString() : yestVisits}</td>
          <td class="px-6 py-4 text-stone-600 font-medium">${(item.visits ?? 0).toLocaleString()}</td>
          <td class="px-6 py-4 text-stone-600 font-medium">${item.durationText ?? "0s"}</td>
        `;
        tb.appendChild(row);
      });

      window.__terms = terms;
      window.__yesterdayMap = yesterdayMap;
      renderPagination(terms.length);
      if (window.lucide && typeof window.lucide.createIcons === "function") {
        lucide.createIcons();
      }
    }

    function openModal(id) {
      const terms = window.__terms || [];
      const item = terms.find(t => t.id === id);
      if (!item) return;

      $("modalTitle").innerText = `词条详情: ${item.term}`;
      $("modalVisits").innerText = (item.visits ?? 0).toLocaleString();
      $("modalDuration").innerText = item.durationText ?? "0s";
      $("modalActiveDays").innerText = (item.activeDays ?? 0).toLocaleString();

      $("termModal").classList.remove("hidden");

      const ctx = $("detailChart").getContext("2d");
      if (detailChart) detailChart.destroy();

      const events = lastEventsCache || [];
      const t = buildTermTrend5d(events, id);

      detailChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: t.labels,
          datasets: [{
            data: t.data,
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            borderColor: "#b45309",
            backgroundColor: "rgba(217, 119, 6, 0.15)"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { display: false },
            x: { grid: { display: false } }
          }
        }
      });
    }

    function closeModal() {
      $("termModal").classList.add("hidden");
    }

    window.openModal = openModal;
    window.closeModal = closeModal;

    window.onclick = function(event) {
      const modal = $("termModal");
      if (event.target === modal) closeModal();
    };

    function setRange(range) {
      currentRange = range;
      currentTermPage = 1;
      const btns = [
        ["7d", "range7d"],
        ["24h", "range24h"],
        ["30d", "range30d"]
      ];
      for (const [r, id] of btns) {
        const b = $(id);
        if (r === range) {
          b.className = "px-3 py-1 rounded-md bg-stone-900 text-white text-xs";
        } else {
          b.className = "px-3 py-1 rounded-md bg-white border border-stone-200 text-stone-700 text-xs";
        }
      }
    }

    function setTrendRange(range) {
      currentTrendRange = range;
      const btn7 = $("tab7d");
      const btn30 = $("tab30d");
      const activeClasses = ["bg-white", "shadow", "text-stone-900"];
      const inactiveClasses = ["text-stone-500", "hover:text-stone-700"];

      if (range === "7d") {
        btn7.classList.add(...activeClasses);
        btn7.classList.remove(...inactiveClasses);
        btn30.classList.remove(...activeClasses);
        btn30.classList.add(...inactiveClasses);
      } else {
        btn30.classList.add(...activeClasses);
        btn30.classList.remove(...inactiveClasses);
        btn7.classList.remove(...activeClasses);
        btn7.classList.add(...inactiveClasses);
      }
    }

    $("range7d").addEventListener("click", () => { setRange("7d"); refreshAll(); });
    $("range24h").addEventListener("click", () => { setRange("24h"); refreshAll(); });
    $("range30d").addEventListener("click", () => { setRange("30d"); refreshAll(); });

    $("tab7d").addEventListener("click", () => { setTrendRange("7d"); refreshAll(); });
    $("tab30d").addEventListener("click", () => { setTrendRange("30d"); refreshAll(); });

    $("refreshBtn").addEventListener("click", () => refreshAll());

    $("exportBtn").addEventListener("click", (e) => {
      e.stopPropagation();
      $("exportMenu").classList.toggle("hidden");
    });

    document.addEventListener("click", () => {
      $("exportMenu").classList.add("hidden");
    });

    async function refreshAll() {
      try {
        const { dash, terms, mode, events } = await (async () => {
          try {
            const api = await loadFromApi();
            return api;
          } catch (_) {
            return await loadFromEventsFallback();
          }
        })();

        if (mode === "events" && events) lastEventsCache = events;

        renderStats(dash);
        renderTrend(dash);
        let eventsForYesterday = lastEventsCache;
        if (!eventsForYesterday.length) {
          try {
            const payload = await tryFetchJson(`/events?limit=${EVENTS_LIMIT}`);
            eventsForYesterday = payload.events || [];
          } catch (_) {
            eventsForYesterday = [];
          }
        }
        if (eventsForYesterday.length) lastEventsCache = eventsForYesterday;
        const featureFromEvents = buildFeatureFromEvents(eventsForYesterday);
        renderFeature(featureFromEvents ? { feature: featureFromEvents } : dash);
        const langMetrics = buildLangMetrics(eventsForYesterday);
        renderLang(langMetrics);
        const yesterdayMap = buildYesterdayVisitsMap(eventsForYesterday);
        renderTable(terms, yesterdayMap);

        setStatus(true, "已连接");
      } catch (err) {
        console.error(err);
        setStatus(false, "连接失败（检查后端是否运行）");
      }
    }

    setRange("7d");
    setTrendRange("7d");
    refreshAll();
    setInterval(refreshAll, POLL_MS);
  </script>
</body>
</html>
